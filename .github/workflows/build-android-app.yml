name: Build Android app

# Configure GitHub Actions to run the jobs whenever any of these things happens:
# 1. Someone clicks the "Run workflow" button on the "Actions" page on GitHub.
# 2. Someone pushes commits onto the `main` branch.
# 3. Someone opens a Pull Request based upon the `main` branch.
#
# References:
# - https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch
# - https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#push
# - https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request
on:
  workflow_dispatch: {}
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Building commit ${{ github.sha }}"
      - name: Check out the commit
        uses: actions/checkout@v4
      # TODO: Set up keystore.
      - run: echo TODO
      - name: Set up Java
        uses: actions/setup-java@v4 # docs: https://github.com/actions/setup-java
        with:
          distribution: corretto # "corretto" refers to the "Amazon Corretto Build of OpenJDK"
          java-version: 17
          cache: gradle
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3 # docs: https://github.com/marketplace/actions/setup-android-sdk-tools
        with:
          # Specify Android SDK 34 using its "command-line identifier" from https://developer.android.com/studio#command-line-tools-only
          # Note: Android SDK 34 is the "targetSdkVersion" listed in `android/variables.gradle`.
          cmdline-tools-version: 13114758 # `13114758` is Android SDK 34
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          # See Node.js support timeline at: https://nodejs.org/en/about/previous-releases#release-schedule
          node-version: 20
          cache: npm
      - name: Install npm packages
        run: npm ci
      - name: Install Ionic CLI
        run: npm install -g @ionic/cli
      - name: Build and copy web assets
        run: ionic capacitor sync android
      # TODO: I don't know whether this step is necessary.
      - name: Make gradle wrapper executable
        working-directory: android
        run: chmod +x ./gradlew
      # Reference: https://docs.gradle.org/current/userguide/gradle_daemon.html#sec:disabling_the_daemon
      # Reference: https://developer.android.com/build/building-cmdline#build_apk
      - name: Generate APK
        working-directory: android
        # Note: Instead of renaming the APK file now, we'll rename it after we download it as an artifact.
        run: ./gradlew --no-daemon build
      - name: Show built files
        working-directory: android
        run: ls -al app/build/outputs/apk/prod/release
      - name: Upload APK as a GHA artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: android/app/build/outputs/apk/prod/release/app-prod-release-unsigned.apk
      - name: Generate AAB
        working-directory: android
        run: ./gradlew --no-daemon bundle
      # - name: Upload AAB as a GHA artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: aab
      #     path: android/build/app-prod-release.aab
